## Балансировка нагрузки

**Балансировка нагрузки** позволяет распределять входящий сетевой трафик между несколькими ресурсами, обеспечивая высокую доступность и надёжность за счёт отправки запросов только к тем ресурсам, которые находятся в рабочем состоянии. Это даёт возможность добавлять или убирать ресурсы по мере изменения спроса.

## Но зачем это нужно?

Современные высоконагруженные веб-сайты должны обрабатывать сотни тысяч, если не миллионы, одновременных запросов от пользователей или клиентов. Чтобы экономически эффективно масштабироваться для таких объёмов, лучшие практики современной вычислительной техники требуют добавления большего количества серверов.

**Балансировщик нагрузки** может располагаться перед серверами и направлять клиентские запросы на те серверы, которые способны их обработать, таким образом, чтобы максимизировать скорость и использование ресурсов. Это гарантирует, что ни один сервер не будет перегружен, что могло бы снизить производительность. Если один сервер выходит из строя, балансировщик перенаправляет трафик на оставшиеся работающие серверы. Когда в группу добавляется новый сервер, балансировщик автоматически начинает отправлять запросы и на него.

## Распределение рабочей нагрузки

Это основная функция балансировщика нагрузки, которая имеет несколько распространённых вариантов реализации:

- **На основе хоста (Host-based):** Распределяет запросы на основе запрошенного имени хоста.
    
- **На основе пути (Path-based):** Использует полный URL-адрес для распределения запросов, а не только имя хоста.
    
- **На основе содержимого (Content-based):** Анализирует содержимое сообщения запроса. Это позволяет распределять нагрузку на основе таких параметров, как значение того или иного поля.


## Уровни работы балансировщиков

Как правило, балансировщики нагрузки работают на одном из двух уровней:

### Сетевой уровень (Network layer / Layer 4)

Это балансировщик, работающий на **транспортном уровне** сети (также известном как **Уровень 4**). Он выполняет маршрутизацию на основе сетевой информации, такой как IP-адреса, и не способен выполнять маршрутизацию на основе содержимого. Часто такие балансировщики реализованы в виде специализированных аппаратных устройств, способных работать на очень высокой скорости.

### Прикладной уровень (Application layer / Layer 7)

Это балансировщик, работающий на **прикладном уровне** (также известном как **Уровень 7**). Такие балансировщики могут читать запросы целиком и выполнять маршрутизацию на основе их содержимого. Это позволяет управлять нагрузкой на основе полного понимания трафика.

## Типы балансировщиков нагрузки
### Программные балансировщики (Software)

Программные балансировщики нагрузки обычно проще в развёртывании, чем аппаратные версии. Они также, как правило, более экономичны и гибки и используются в сочетании со средами разработки программного обеспечения. Программный подход даёт нам гибкость настройки балансировщика под конкретные потребности нашей среды. Однако эта гибкость может достигаться ценой необходимости выполнять больше работы по настройке балансировщика. По сравнению с аппаратными версиями, которые предлагают более "закрытый" подход (closed-box), программные балансировщики дают нам больше свободы для внесения изменений и обновлений.

Программные балансировщики нагрузки широко используются и доступны либо как устанавливаемые решения, требующие настройки и управления, либо как управляемый облачный сервис.

### Аппаратные балансировщики (Hardware)

Как следует из названия, аппаратный балансировщик нагрузки полагается на физическое оборудование, установленное локально (on-premises), для распределения трафика приложений и сети. Такие устройства могут обрабатывать большие объёмы трафика, но часто имеют высокую цену и довольно ограничены с точки зрения гибкости.

Аппаратные балансировщики нагрузки включают проприетарное (собственническое) программное обеспечение (firmware), которое требует обслуживания и обновления по мере выпуска новых версий и исправлений безопасности.

### DNS-балансировка

DNS-балансировка нагрузки — это практика настройки домена в системе DNS таким образом, чтобы клиентские запросы к этому домену распределялись по группе серверов.

К сожалению, DNS-балансировка имеет внутренние проблемы, ограничивающие её надёжность и эффективность. Наиболее существенная проблема: DNS не проверяет наличие сбоев серверов и сети или ошибок. Он всегда возвращает один и тот же набор IP-адресов для домена, даже если серверы не работают или недоступны.

## Алгоритмы маршрутизации

Теперь давайте обсудим часто используемые алгоритмы маршрутизации:

- **Круговой перебор (Round-robin):** Запросы распределяются по серверам приложений по очереди.
    
- **Взвешенный круговой перебор (Weighted Round-robin):** Развитие простого метода Round-robin, учитывающее различные характеристики серверов, такие как вычислительная мощность и способность обрабатывать трафик, с помощью весов (weights), которые могут быть назначены администратором через DNS-записи.
    
- **Наименьшее количество соединений (Least Connections):** Новый запрос отправляется серверу с наименьшим количеством текущих подключений от клиентов. Относительная вычислительная мощность каждого сервера учитывается при определении того, у кого меньше всего соединений.
    
- **Наименьшее время ответа (Least Response Time):** Отправляет запросы на сервер, выбранный по формуле, которая объединяет самое быстрое время ответа и наименьшее количество активных соединений.
    
- **Наименьшая пропускная способность (Least Bandwidth):** Этот метод измеряет трафик в мегабитах в секунду (Mbps), отправляя клиентские запросы серверу с наименьшим трафиком в Mbps.
    
- **Хеширование (Hashing):** Распределяет запросы на основе определённого нами ключа, такого как IP-адрес клиента или URL запроса.
## Преимущества

Балансировка нагрузки также играет ключевую роль в предотвращении простоев. Другие преимущества балансировки нагрузки включают:

- **Масштабируемость (Scalability)**
    
- **Резервирование (Redundancy)**
    
- **Гибкость (Flexibility)**
    
- **Эффективность (Efficiency)**

## Резервирование балансировщиков нагрузки

Как вы уже, наверное, догадались, сам балансировщик нагрузки может быть **единой точкой отказа** (single point of failure). Чтобы преодолеть это, второй или N-ное количество балансировщиков нагрузки могут быть использованы в кластерном режиме.

И если обнаружен сбой и активный балансировщик нагрузки выходит из строя, другой пассивный балансировщик нагрузки может взять на себя его функции, что сделает нашу систему более **отказоустойчивой** (fault-tolerant).